#!/bin/bash
#
# Script for running all the benchmark files.
#   It will run each benchmark 3 times.
#   Each run will output into a result file and in the end presented.

# Get root directory for all tests
root="$(pwd)/Test"

# Get root directory for Test #1
testIO="${root}/Test-IO"

# Get root directory for Test #2
testGL="${root}/Test-GrafList"


# Get Start Time in nanoseconds
function start_time {
    start=$(date +%s%N)
    echo "Start (ns)  $start"
}

# Get Stop Time in nanoseconds
function end_time {
    stop=$(date +%s%N)
    echo "Stop  (ns)  $stop"
}

# Calculate Time spent in nanoseconds and milliseconds
function calc_time {
    end_time
    time_spent=$(echo "${stop}-${start}" | bc -l)
    time_spent_ms=$(echo "scale=3; ${time_spent}/1000000" | bc -l)
    echo "Total (ms)  $time_spent_ms"
}

# Pass arguments to calculate time spend in milliseconds
function time_spent {
    echo
    echo "${1}"
    start_time
    ${2} &>/dev/null
    calc_time
}

function calc_mem {
    file=temp
    echo
    echo "Calculating memory for ${1}"
    valgrind ${2} &> ${file}
    tail -15 ${file}
    rm ${file}
}

# Prepare for IO test
function prepareDumpFile {
    cd "${testIO}/DumpFile"
    echo "Location: $(pwd)"

    time_spent  "Compiling DumpFile" "javac Lorem.java"
    time_spent  "Starting Lorem Processing" "java Lorem"
    calc_mem    "Lorem" "java Lorem"
}

# Prepare for Test-GrafList
function prepareGrafList {
    cd "${testGL}/DumpFile"
    echo "Location: $(pwd)"
    echo "Generating DumpFile"

    head -n 5000 "${testIO}/DumpFile/dump.txt" > dump.txt
}

prepareDumpFile
prepareGrafList
